# レビュー結果: わんこめ参加型機能人数表示ツール

レビュー日: 2026-02-08 | 更新日: 2026-02-08（わんこめプラグイン化対応）

## ✅ 解決済み Critical

### 1. [ARCH] ブラウザのファイルアクセス制限 → **解決**
**変更**: わんこめプラグインとして実装することで、Node.js環境でfs APIを使用可能に。
**影響**: ブラウザ制限の問題が完全に解消。

### 2. [EXT] onecommeがcount.txtを削除・上書きする可能性 → **対応済み**
**変更**: 出力ファイル名を`onecomme_waiting_count.txt`に変更。
**理由**: onecomme公式が使用する可能性のない独自ファイル名を採用。

### 3. [PERF] ディスクI/O負荷 → **大幅改善**
**変更**: ポーリングからfs.watch()によるイベント駆動監視に変更。
**効果**:
- アイドル時のCPU使用率 0%
- ファイル変更時のみ読み込み（無駄なI/O削減）
- リアルタイム性向上（1秒待たずに即座に反映）

### 4. [SEC] XSS脆弱性 → **該当なし**
**変更**: UIを持たないプラグインとして実装。接頭辞/接尾辞はコード内定数。
**理由**: ユーザー入力を受け付けないため、XSSリスクは存在しない。

## ⚠️ Warning（推奨対応）

### 5. [QA] waiting.txtの行形式が仕様と異なる場合のエラー
**問題**: waiting.txtの形式が`番号→名前  |||`と異なる場合、カウントが不正確になる。
**影響**: 人数が0人と表示される、または不正確な人数。
**推奨対応**:
- 柔軟なパースロジック（`|||`の有無に関わらず行数をカウント）
- または、形式不正時にエラー表示（UI上で「フォーマットエラー」と表示）

### 6. [UX] エラー発生時のユーザーフィードバック不足
**問題**: ファイル読み込み失敗時、コンソールログのみでUIに表示されない。
**影響**: 配信者がエラーに気づかない。
**推奨対応**:
- UI上に「最終更新時刻」を表示
- エラー時は「⚠️ ファイル読込エラー（前回値: X人）」と表示

### 7. [SRE] count.txtへの書き込み失敗時のリトライがない
**問題**: 一時的なファイルロック等で書き込み失敗した場合、再試行しない。
**影響**: OBS側で古い人数が表示され続ける。
**推奨対応**:
- 書き込み失敗時、次回ポーリング時に再試行
- または、100ms後にリトライ（最大3回）

### 8. [DATA] count.txtのアトミック書き込み保証
**問題**: 書き込み中にOBSが読み込むと、不完全なデータを読む可能性。
**影響**: OBS画面に一瞬「参加者:」だけ表示される等。
**推奨対応**:
- 一時ファイルに書き込んでからリネーム（アトミック操作）
- または、Node.jsの`fs.writeFileSync`は基本的にアトミック

### 9. [PERF] ブラウザタブを閉じても監視が停止しない（Electron化の場合）
**問題**: Electronでバックグラウンド実行する場合、ウィンドウを閉じても監視が続く。
**影響**: リソース消費、意図しない動作。
**推奨対応**:
- ウィンドウ閉じる時にポーリングを停止
- または、トレイアイコンで「終了」ボタンを用意

### 10. [BIZ] 設定の永続化がない
**問題**: ブラウザリロード時、設定が初期値に戻る。
**影響**: 毎回カスタマイズが必要。
**推奨対応**:
- localStorage または config.json に設定を保存
- 次回起動時に自動読み込み

## 💡 Info（検討推奨）

### 11. [UX] OBSでの表示確認手順が不明確
**提案**: README.mdにOBS設定手順を記載
- テキストソースの追加方法
- count.txtの読み込み設定
- 更新間隔の推奨値（1秒）

### 12. [DATA] 参加者名の履歴を記録しない
**提案**: 将来の機能拡張として、参加者の入退室履歴を記録
- 統計分析（平均参加人数、ピーク時間）
- 参加者リストのエクスポート機能

### 13. [PERF] waiting.txtが巨大になった場合のパフォーマンス
**提案**: 1000行以上の場合、パース処理が遅延する可能性
- ストリーム処理または行数のみカウント（全行を読まない）
- 現実的には100行以下と想定されるため、優先度低

### 14. [LEGAL] onecommeのライセンス・利用規約の確認
**提案**: onecommeがファイルへのアクセスを許可しているか確認
- 利用規約でファイル監視が禁止されていないか
- データの二次利用について

### 15. [ARCH] 将来的な拡張性（他の配信ツールへの対応）
**提案**: waiting.txt以外のフォーマットにも対応できる設計
- プラグイン方式（パーサーを差し替え可能）
- 設定ファイルで監視ファイルのパスとフォーマットを指定

## レビュー総括

### 優先度付き対応リスト（プラグイン化後）

| 優先度 | ID | 項目 | ステータス | 工数目安 |
|--------|----|----|----------|----------|
| ✅ 解決 | 1 | ブラウザのファイルアクセス制限 | わんこめプラグイン化で解決 | - |
| ✅ 解決 | 2 | count.txtファイル名の競合 | onecomme_waiting_count.txt に変更 | - |
| ✅ 解決 | 3 | ディスクI/O負荷 | fs.watch()で解決 | - |
| ✅ 解決 | 4 | XSS脆弱性 | UI不要のため該当なし | - |
| 🟠 P1 | 8 | アトミック書き込み | tmpファイル→rename方式 | 0.5h |
| 🟠 P1 | 5 | 柔軟なwaiting.txtパース | 空行無視、フォーマット寛容 | 0.5h |
| 🟠 P1 | 12 | fs.watch()のデバウンス処理 | 100ms以内の連続イベント無視 | 0.5h |
| 🟡 P2 | 6 | エラー時のログ出力 | コンソールログ充実 | 0.5h |
| 🟡 P2 | 11 | README.mdのOBS設定手順 | ドキュメント作成 | 0.5h |

### MECE（漏れ・重複）チェック
- ✅ **セキュリティ**: XSS対策は検出
- ✅ **パフォーマンス**: ディスクI/O、mtimeチェック
- ✅ **エラーハンドリング**: ファイル読み書き失敗、フォーマットエラー
- ✅ **運用性**: ログ、UIフィードバック、リトライ
- ✅ **拡張性**: 将来的な機能拡張の余地
- ⚠️ **監視方法**: ポーリング以外（inotify/fs.watch）は未検討 → 追加提案

### 追加提案: fs.watchによるイベント駆動監視

**現状の課題**: 1秒毎のポーリングは無駄なリソース消費。

**提案**: Node.jsの`fs.watch()`でwaiting.txtの変更をイベント駆動で検知。

**メリット**:
- CPU使用率削減
- リアルタイム性向上（1秒待たずに即座に更新）
- ディスクI/O削減

**デメリット**:
- macOSでのfs.watchの不安定性（watchman推奨）
- 実装複雑度が若干上昇

**推奨**: P2として検討（ポーリングでも実用上問題なし）

## 次のアクション

1. **実装開始**: `/dev` でプラグインコード実装
   - index.js: メインロジック（fs.watch、パース、書き込み）
   - package.json: プラグイン定義
2. **実装時の注意**:
   - アトミック書き込み（tmpファイル→rename）
   - fs.watch()のデバウンス処理
   - 柔軟なパース（空行無視、`|||`の有無に寛容）
3. **テスト**: わんこめでプラグインを有効化し、OBSで動作確認
4. **ドキュメント**: README.mdにインストール手順とOBS設定手順を追加
